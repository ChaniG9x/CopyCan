//@version=5
indicator("Early Adopter Setup Rater [Bullish Only]", overlay=true)

// === INPUTS ===
showDebug = input.bool(false, "Show Debug Labels")

// === FUNCTIONS ===
// Price Action Phase Detection (Bullish Only)
phaseBullish(close_, openPrevRed, isPrevGreen, openPrevGreen) =>
    (not isPrevGreen and close_ > openPrevRed) or (isPrevGreen and close_ >= openPrevGreen)

// EMA Alignment (Bullish)
emaAlignedBullish(src) =>
    e10 = ta.ema(src, 10)
    e20 = ta.ema(src, 20)
    e50 = ta.ema(src, 50)
    e100 = ta.ema(src, 100)
    e200 = ta.ema(src, 200)
    stacked = (e10 > e20 and e20 > e50 and e50 > e100 and e100 > e200)
    priceAbove = src > e10 and src > e20 and src > e50 and src > e100 and src > e200
    stacked and priceAbove

// === CONTEXT CHECK ===
isWeekly = timeframe.isweekly

// === HTF DATA ===
monthlyClose = request.security(syminfo.tickerid, "M", close[1])
monthlyOpenPrevRed = request.security(syminfo.tickerid, "M", open[2])
monthlyWasGreen = request.security(syminfo.tickerid, "M", close[2] > open[2])
monthlyOpenPrevGreen = request.security(syminfo.tickerid, "M", open[2])
monthlyBullish = phaseBullish(monthlyClose, monthlyOpenPrevRed, monthlyWasGreen, monthlyOpenPrevGreen)

weeklyClose = close[1]
weeklyOpenPrevRed = open[2]
weeklyWasGreen = close[2] > open[2]
weeklyOpenPrevGreen = open[2]
weeklyBullish = phaseBullish(weeklyClose, weeklyOpenPrevRed, weeklyWasGreen, weeklyOpenPrevGreen)

// EMA Alignment (HTFs)
monthlyEMAAligned = request.security(syminfo.tickerid, "M", emaAlignedBullish(close))
weeklyEMAAligned = emaAlignedBullish(close)

// === SETUP RATING ===
setupType = (monthlyBullish and weeklyBullish) ?
     (monthlyEMAAligned and weeklyEMAAligned ? "A" : "B") : "-"

// === TABLE OUTPUT (ONLY WEEKLY CHART) ===
var table t = table.new(position.top_left, 2, 5, frame_width=1)
if bar_index % 5 == 0 and isWeekly
    table.cell(t, 0, 0, "Setup Type:", text_color=color.white, bgcolor=color.navy)
    table.cell(t, 1, 0, setupType, text_color=color.white, bgcolor=(setupType == "A" ? color.green : setupType == "B" ? color.orange : color.gray))

    table.cell(t, 0, 1, "Monthly:", text_color=color.white)
    table.cell(t, 1, 1, monthlyBullish ? "Bullish" : "Bearish", text_color=color.white)

    table.cell(t, 0, 2, "Weekly:", text_color=color.white)
    table.cell(t, 1, 2, weeklyBullish ? "Bullish" : "Bearish", text_color=color.white)

    table.cell(t, 0, 3, "EMAs Aligned (W):", text_color=color.white)
    table.cell(t, 1, 3, weeklyEMAAligned ? "Yes" : "No", text_color=color.white)

    table.cell(t, 0, 4, "EMAs Aligned (M):", text_color=color.white)
    table.cell(t, 1, 4, monthlyEMAAligned ? "Yes" : "No", text_color=color.white)
