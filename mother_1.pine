// ——— CONSISTENT HIGHER TIMEFRAME ANALYSIS (Isolated) ———
// This function ensures consistent results regardless of current timeframe

f_get_market_condition() =>
    // Force consistent timeframe strings
    monthly_tf = "1M"
    weekly_tf = "1W"
    
    // Get monthly data with consistent settings
    [m_open, m_close, m_ema10, m_ema20, m_ema50, m_ema100] = request.security(
        syminfo.tickerid, monthly_tf,
        [open[1], close[1], ta.ema(close, 10), ta.ema(close, 20), ta.ema(close, 50), ta.ema(close, 100)],
        lookahead=barmerge.lookahead_off
    )
    
    // Get weekly data with consistent settings  
    [w_open, w_close, w_ema10, w_ema20, w_ema50, w_ema100] = request.security(
        syminfo.tickerid, weekly_tf,
        [open[1], close[1], ta.ema(close, 10), ta.ema(close, 20), ta.ema(close, 50), ta.ema(close, 100)],
        lookahead=barmerge.lookahead_off
    )
    
    // Monthly bias logic
    monthly_bullish = not na(m_close) and not na(m_open) and m_close > m_open
    monthly_ema_aligned = not na(m_ema10) and not na(m_ema20) and not na(m_ema50) and not na(m_ema100) and
                         m_ema10 > m_ema20 and m_ema20 > m_ema50 and m_ema50 > m_ema100
    
    // Weekly bias logic  
    weekly_bullish = not na(w_close) and not na(w_open) and w_close > w_open
    weekly_ema_aligned = not na(w_ema10) and not na(w_ema20) and not na(w_ema50) and not na(w_ema100) and
                        w_ema10 > w_ema20 and w_ema20 > w_ema50 and w_ema50 > w_ema100
    
    // Overall condition
    condition = if monthly_bullish and weekly_bullish
        if monthly_ema_aligned and weekly_ema_aligned
            "Setup A"
        else
            "Setup B" 
    else
        "NO TRADE"
        
    [condition, monthly_bullish, weekly_bullish, monthly_ema_aligned, weekly_ema_aligned]

// ——— GET CONSISTENT MARKET CONDITION ———
[market_condition, is_monthly_bull, is_weekly_bull, is_monthly_aligned, is_weekly_aligned] = f_get_market_condition()

// ——— YOUR 1MIN TRADING LOGIC (Now Consistent) ———
is_1min_timeframe = timeframe.period == "1"

// These conditions will be the same regardless of what timeframe you're viewing the chart on
can_trade_setup_a = market_condition == "Setup A"
can_trade_setup_b = market_condition == "Setup B" 
no_trade_allowed = market_condition == "NO TRADE"

// Your 1min trading logic
if is_1min_timeframe and can_trade_setup_a
    // Setup A trading logic
    // This will work consistently across all chart timeframes
    label.new(bar_index, low, "Trading Setup A", color=color.green, style=label.style_label_up)

if is_1min_timeframe and can_trade_setup_b  
    // Setup B trading logic
    // This will work consistently across all chart timeframes
    label.new(bar_index, low, "Trading Setup B", color=color.orange, style=label.style_label_up)

// ——— EXAMPLE: More Specific 1Min Logic ———
if is_1min_timeframe
    // Get your 1min specific conditions
    ema10_1min = ta.ema(close, 10)
    ema20_1min = ta.ema(close, 20)
    
    // Combine higher timeframe condition with 1min technicals
    setup_a_entry = can_trade_setup_a and close > ema10_1min and ema10_1min > ema20_1min
    setup_b_entry = can_trade_setup_b and close > ema20_1min  // Different criteria for Setup B
    
    if setup_a_entry
        strategy.entry("Long A", strategy.long, comment="Setup A Entry")
        
    if setup_b_entry  
        strategy.entry("Long B", strategy.long, comment="Setup B Entry")

// ——— CONSISTENT TABLE (Updated) ———
var table bias_tbl = table.new(position.top_right, 3, 5, border_width=1)

if barstate.isfirst
    table.cell(bias_tbl, 0, 0, "Timeframe", text_color=color.white, bgcolor=color.blue)
    table.cell(bias_tbl, 1, 0, "Status", text_color=color.white, bgcolor=color.blue)  
    table.cell(bias_tbl, 2, 0, "EMA Order", text_color=color.white, bgcolor=color.blue)

// Table will now show consistent values
monthly_status_text = is_monthly_bull ? "Bullish" : "Bearish"
weekly_status_text = is_weekly_bull ? "Bullish" : "Bearish" 
monthly_ema_text = is_monthly_aligned ? "Aligned" : "Not Aligned"
weekly_ema_text = is_weekly_aligned ? "Aligned" : "Not Aligned"

table.cell(bias_tbl, 0, 1, "Monthly", text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 1, monthly_status_text, text_color=(is_monthly_bull ? color.green : color.red))
table.cell(bias_tbl, 2, 1, monthly_ema_text, text_color=(is_monthly_aligned ? color.green : color.red))

table.cell(bias_tbl, 0, 2, "Weekly", text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 2, weekly_status_text, text_color=(is_weekly_bull ? color.green : color.red))
table.cell(bias_tbl, 2, 2, weekly_ema_text, text_color=(is_weekly_aligned ? color.green : color.red))

table.cell(bias_tbl, 0, 3, "Condition", text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 3, market_condition, text_color=(market_condition == "NO TRADE" ? color.red : color.green))
table.cell(bias_tbl, 2, 3, "")

// ——— DEBUG: Show what condition we're getting ———
if barstate.islast
    label.new(bar_index, high, "Current: " + market_condition + "\nTF: " + timeframe.period, 
              style=label.style_label_down, color=color.blue, textcolor=color.white)
