//@version=5
indicator("HTF Structure + EMA Rating", overlay=true)

// === Timeframe settings ===
monthly_tf = "M"
weekly_tf = "W"

// === MONTHLY STRUCTURE ===
var string monthly_status = na
var float monthly_prev_green_open = na
var float monthly_prev_red_open   = na

monthly_close      = request.security(syminfo.tickerid, monthly_tf, close)
monthly_open       = request.security(syminfo.tickerid, monthly_tf, open)
monthly_prev_close = request.security(syminfo.tickerid, monthly_tf, close[1])
monthly_prev_open  = request.security(syminfo.tickerid, monthly_tf, open[1])

if (monthly_prev_close > monthly_prev_open)
    monthly_prev_green_open := monthly_prev_open
else if (monthly_prev_close < monthly_prev_open)
    monthly_prev_red_open := monthly_prev_open

if (monthly_close > monthly_open and monthly_close > monthly_prev_red_open)
    monthly_status := "Bullish"
else if (monthly_close < monthly_open and monthly_close < monthly_prev_green_open)
    monthly_status := "Bearish"

// === WEEKLY STRUCTURE ===
var string weekly_status = na
var float weekly_prev_green_open = na
var float weekly_prev_red_open   = na

weekly_close      = request.security(syminfo.tickerid, weekly_tf, close)
weekly_open       = request.security(syminfo.tickerid, weekly_tf, open)
weekly_prev_close = request.security(syminfo.tickerid, weekly_tf, close[1])
weekly_prev_open  = request.security(syminfo.tickerid, weekly_tf, open[1])

if (weekly_prev_close > weekly_prev_open)
    weekly_prev_green_open := weekly_prev_open
else if (weekly_prev_close < weekly_prev_open)
    weekly_prev_red_open := weekly_prev_open

if (weekly_close > weekly_open and weekly_close > weekly_prev_red_open)
    weekly_status := "Bullish"
else if (weekly_close < weekly_open and weekly_close < weekly_prev_green_open)
    weekly_status := "Bearish"

// === EMA STACK FUNCTION ===
ema_ok(tf) =>
    ema10  = request.security(syminfo.tickerid, tf, ta.ema(close, 10))
    ema20  = request.security(syminfo.tickerid, tf, ta.ema(close, 20))
    ema50  = request.security(syminfo.tickerid, tf, ta.ema(close, 50))
    ema100 = request.security(syminfo.tickerid, tf, ta.ema(close, 100))
    ema200 = request.security(syminfo.tickerid, tf, ta.ema(close, 200))
    ema10 > ema20 and ema20 > ema50 and ema50 > ema100 and ema100 > ema200

monthly_ema_ok = ema_ok(monthly_tf)
weekly_ema_ok  = ema_ok(weekly_tf)

// === RATING CALCULATION ===
var string rating = na
structure_is_bullish = (monthly_status == "Bullish") and (weekly_status == "Bullish")

if structure_is_bullish and monthly_ema_ok and weekly_ema_ok
    rating := "A"
else if structure_is_bullish
    rating := "B"
else
    rating := "No Trade"

// === PLOT CURRENT-TF EMAs ON CHART ===
ema10  = ta.ema(close, 10)
ema20  = ta.ema(close, 20)
ema50  = ta.ema(close, 50)
ema100 = ta.ema(close, 100)
ema200 = ta.ema(close, 200)

plot(ema10,  title="EMA 10",  color=color.blue)
plot(ema20,  title="EMA 20",  color=color.red)
plot(ema50,  title="EMA 50",  color=color.gray)
plot(ema100, title="EMA 100", color=color.purple)
plot(ema200, title="EMA 200", color=color.orange)

// === DEBUG TABLE ===
var table status_table = table.new(position.top_right, 2, 3, border_width=1)

if bar_index % 5 == 0  // update every 5 bars
    table.cell(status_table, 0, 0, "Monthly", text_color=color.white, bgcolor=color.blue)
    table.cell(status_table, 1, 0, "Weekly",  text_color=color.white, bgcolor=color.blue)

    table.cell(status_table, 0, 1, na(monthly_status) ? "..." : monthly_status, text_color=color.white)
    table.cell(status_table, 1, 1, na(weekly_status) ? "..." : weekly_status, text_color=color.white)

    table.cell(status_table, 0, 2, "Rating", text_color=color.white, bgcolor=color.navy)
    table.cell(status_table, 1, 2, na(rating) ? "..." : rating,
        text_color=(rating == "A" ? color.green : rating == "B" ? color.orange : color.red))
