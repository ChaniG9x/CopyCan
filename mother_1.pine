//@version=5
indicator("Monthly & Weekly Bias + EMA Order + Overall Condition", overlay=true)

// ——— Helper to track last opposite‐color open ———
f_prev_opposite_open(_res) =>
    var float prev_green_open = na
    var float prev_red_open   = na
    _c = request.security(syminfo.tickerid, _res, close[1], lookahead=barmerge.lookahead_off)
    _o = request.security(syminfo.tickerid, _res, open[1],  lookahead=barmerge.lookahead_off)
    if _c > _o
        prev_green_open := _o
    else if _c < _o
        prev_red_open   := _o
    [ prev_green_open, prev_red_open ]

// ——— Monthly Status ———
[ m_prev_green_open, m_prev_red_open ] = f_prev_opposite_open("M")
m_open_closed  = request.security(syminfo.tickerid, "M", open[1],  lookahead=barmerge.lookahead_off)
m_close_closed = request.security(syminfo.tickerid, "M", close[1], lookahead=barmerge.lookahead_off)
var string monthly_status = "Bearish"
if m_close_closed > m_open_closed and m_close_closed > m_prev_red_open
    monthly_status := "Bullish"
else if m_close_closed < m_open_closed and m_close_closed < m_prev_green_open
    monthly_status := "Bearish"

// ——— Weekly Status ———
[ w_prev_green_open, w_prev_red_open ] = f_prev_opposite_open("W")
w_open_closed  = request.security(syminfo.tickerid, "W", open[1],  lookahead=barmerge.lookahead_off)
w_close_closed = request.security(syminfo.tickerid, "W", close[1], lookahead=barmerge.lookahead_off)
var string weekly_status = "Bearish"
if w_close_closed > w_open_closed and w_close_closed > w_prev_red_open
    weekly_status := "Bullish"
else if w_close_closed < w_open_closed and w_close_closed < w_prev_green_open
    weekly_status := "Bearish"

// ——— Monthly & Weekly EMAs & Order Flags ———
[ ema10_m, ema20_m, ema50_m, ema100_m ] = request.security(syminfo.tickerid, "M", 
     [ ta.ema(close,10), ta.ema(close,20), ta.ema(close,50), ta.ema(close,100) ], 
     lookahead=barmerge.lookahead_off)
monthly_ema_flag = (ema10_m > ema20_m and ema20_m > ema50_m and ema50_m > ema100_m) ? "Aligned" : "Not Aligned"

[ ema10_w, ema20_w, ema50_w, ema100_w ] = request.security(syminfo.tickerid, "W",
     [ ta.ema(close,10), ta.ema(close,20), ta.ema(close,50), ta.ema(close,100) ],
     lookahead=barmerge.lookahead_off)
weekly_ema_flag = (ema10_w > ema20_w and ema20_w > ema50_w and ema50_w > ema100_w) ? "Aligned" : "Not Aligned"

// ——— Overall Condition Logic ———
string overall_condition = (monthly_status == "Bullish" and weekly_status == "Bullish") ? (monthly_ema_flag == "Aligned" and weekly_ema_flag == "Aligned"? "Setup A"  : "Setup B") : "NO TRADE"

// ——— Plot Daily EMAs (reference) ———
plot(ta.ema(close, 10),  title="EMA 10",  color=color.blue,   linewidth=2)
plot(ta.ema(close, 20),  title="EMA 20",  color=color.red,    linewidth=2)
plot(ta.ema(close, 50),  title="EMA 50",  color=color.gray,   linewidth=2)
plot(ta.ema(close,100),  title="EMA 100", color=color.purple, linewidth=2)
plot(ta.ema(close,200),  title="EMA 200", color=color.orange, linewidth=2)

// ——— Daily Dominant Bullish Bar Tracker ———
daily_close = request.security(syminfo.tickerid, "D", close[1], lookahead=barmerge.lookahead_off)
daily_open  = request.security(syminfo.tickerid, "D", open[1],  lookahead=barmerge.lookahead_off)
daily_color = daily_close > daily_open ? 1 : daily_close < daily_open ? -1 : 0

// Live forming-bar EMA10 and EMA20 (updated every 1m bar)
live_ema10_snapshot = request.security(syminfo.tickerid, "D", ta.ema(close, 10), lookahead=barmerge.lookahead_on)
live_ema20_snapshot = request.security(syminfo.tickerid, "D", ta.ema(close, 20), lookahead=barmerge.lookahead_on)

// Local EMAs for lower timeframe logic
dtf_ema10 = ta.ema(close, 10)
dtf_ema20 = ta.ema(close, 20)
dtf_ema50 = ta.ema(close, 50)
dtf_ema100 = ta.ema(close, 100)
dtf_ema200 = ta.ema(close, 200)

// 5-day lookback to find most recent red candle
red1_o = request.security(syminfo.tickerid, "D", open[1], lookahead=barmerge.lookahead_off)
red1_c = request.security(syminfo.tickerid, "D", close[1], lookahead=barmerge.lookahead_off)
red2_o = request.security(syminfo.tickerid, "D", open[2], lookahead=barmerge.lookahead_off)
red2_c = request.security(syminfo.tickerid, "D", close[2], lookahead=barmerge.lookahead_off)
red3_o = request.security(syminfo.tickerid, "D", open[3], lookahead=barmerge.lookahead_off)
red3_c = request.security(syminfo.tickerid, "D", close[3], lookahead=barmerge.lookahead_off)
red4_o = request.security(syminfo.tickerid, "D", open[4], lookahead=barmerge.lookahead_off)
red4_c = request.security(syminfo.tickerid, "D", close[4], lookahead=barmerge.lookahead_off)
red5_o = request.security(syminfo.tickerid, "D", open[5], lookahead=barmerge.lookahead_off)
red5_c = request.security(syminfo.tickerid, "D", close[5], lookahead=barmerge.lookahead_off)

last_red_open =
     red1_c < red1_o ? red1_o :
     red2_c < red2_o ? red2_o :
     red3_c < red3_o ? red3_o :
     red4_c < red4_o ? red4_o :
     red5_c < red5_o ? red5_o : na

// State
var float dominant_open  = na
var float dominant_close = na

is_new_dominant = daily_color == 1 and ((not na(last_red_open) and daily_close > last_red_open)or (not na(dominant_close) and daily_close > dominant_close))

if is_new_dominant
    dominant_open  := daily_open
    dominant_close := daily_close

    if timeframe.period == "D"
        label.new(bar_index, high,
         "✓ Dominant Bullish\nOpen: " + str.tostring(daily_open, "#.##") +
         "\nClose: " + str.tostring(daily_close, "#.##") +
         "\nEMA10: " + str.tostring(live_ema10_snapshot, "#.##") +
         "\nEMA20: " + str.tostring(live_ema20_snapshot, "#.##"),
         style=label.style_label_down, textcolor=color.white, size=size.small, color=color.green)

// ——— Super Early Entry Pattern Function ———
isSuperEarlyEntry(float ema10, float ema20, float ema50, float ema100, float ema200) =>
    ema10 > ema20 and ema20 > ema200 and ema50 < ema200 and ema100 < ema200 and
    close > open and close[1] < open[1] and
    close > ema10 and
    ((low < ema10 or low < ema20) or (low[1] < ema10 or low[1] < ema20)) and
    ((high > ema10 or high > ema20) or (high[1] > ema10 or high[1] > ema20)) and
    ((high - low) > (high[1] - low[1]))

// Debug labels on 1m or 10s for Super Early Entry pattern
if (timeframe.period == "1" or timeframe.period == "10") and isSuperEarlyEntry(dtf_ema10, dtf_ema20, dtf_ema50, dtf_ema100, dtf_ema200)
    label.new(bar_index, high,
     "Super Early Entry",
     style=label.style_label_up, color=color.yellow, textcolor=color.black, size=size.tiny)

// ——— Final Table ———
var table bias_tbl = table.new(position.top_right, 3, 5, border_width=1)
table.cell(bias_tbl, 0, 0, "Timeframe",      text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 0, "Status",         text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 2, 0, "EMA Order",      text_color=color.white, bgcolor=color.blue)

table.cell(bias_tbl, 0, 1, "Monthly",        text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 1, monthly_status,   text_color=(monthly_status=="Bullish" ? color.green : color.red))
table.cell(bias_tbl, 2, 1, monthly_ema_flag, text_color=(monthly_ema_flag=="Aligned" ? color.green : color.red))

table.cell(bias_tbl, 0, 2, "Weekly",         text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 2, weekly_status,    text_color=(weekly_status=="Bullish" ? color.green : color.red))
table.cell(bias_tbl, 2, 2, weekly_ema_flag,  text_color=(weekly_ema_flag=="Aligned" ? color.green : color.red))

table.cell(bias_tbl, 0, 3, "Condition",      text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 3, overall_condition, text_color=(overall_condition=="NO TRADE" ? color.red : color.green))
table.cell(bias_tbl, 2, 3, "")

table.cell(bias_tbl, 0, 4, "Dominant",       text_color=color.white, bgcolor=color.blue)
table.cell(bias_tbl, 1, 4, "O: " + str.tostring(dominant_open, "#.##") +" / C: " + str.tostring(dominant_close, "#.##"),text_color=color.white)
table.cell(bias_tbl, 2, 4,"EMA10: " + str.tostring(live_ema10_snapshot, "#.##") +"\nEMA20: " + str.tostring(live_ema20_snapshot, "#.##"),text_color=color.white)
