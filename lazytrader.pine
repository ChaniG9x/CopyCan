//@version=5
strategy("Lazy Trader", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// --- Plot EMAs ---
ema10_main = ta.ema(close, 10)
ema20_main = ta.ema(close, 20)
ema200_main = ta.ema(close, 200)
plot(ema10_main, title="EMA 10", color=color.blue)
plot(ema20_main, title="EMA 20", color=color.red)
plot(ema200_main, title="EMA 200", color=color.orange)

// --- Helper function to check cross through EMA ---
crosses(_ema) =>
    (low < _ema) and (high > _ema)

// --- Tier 2 Pattern Detection Logic ---
f_tier2Pattern() =>
    ema10 = ta.ema(close, 10)
    ema20 = ta.ema(close, 20)
    ema200 = ta.ema(close, 200)
    emaTrendOk = (ema10 > ema20) and (ema20 > ema200)

    var bool restricted = false
    var bool bearishCandidate = false
    var bool justReset = false
    justReset := false

    if restricted
        if (close > open) and (close > ema10)
            restricted := false
            justReset := true
            bearishCandidate := false

    var bool permission = false
    if not restricted and not justReset and emaTrendOk
        condA = (close > open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        condBearCandidate = (close < open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        if condBearCandidate
            bearishCandidate := true
        condBConfirm = bearishCandidate and (close > open) and (close > ema10)
        if condA or condBConfirm
            permission := true
            bearishCandidate := false

    if not restricted and not justReset
        if (open < ema20) or (close < ema20)
            restricted := true
            bearishCandidate := false

    result = permission and barstate.isconfirmed and (not restricted)
    permission := false
    result

// --- Tier 3 Pattern Detection Logic ---
f_tier3Pattern() =>
    ema10 = ta.ema(close, 10)
    ema20 = ta.ema(close, 20)
    ema200 = ta.ema(close, 200)
    emaTrendOk = (ema10 > ema20) and (ema20 > ema200)
    t3Valid = (close > open) and (open > ema10) and (close > ema10) and (low > ema10)
    result = emaTrendOk and t3Valid and barstate.isconfirmed
    result

// --- Floating Confirmation Flags ---
patternResult = f_tier2Pattern()
t3patternResult = f_tier3Pattern()

var bool t3confirmed = false
if timeframe.isdaily
    t3confirmed := barstate.isconfirmed ? t3patternResult : t3confirmed[1]

var bool dailyConfirmed = false
if timeframe.isdaily
    dailyConfirmed := barstate.isconfirmed ? patternResult : dailyConfirmed[1]

var bool fourHourConfirmed = false
if timeframe.isintraday and timeframe.multiplier == 240
    fourHourConfirmed := barstate.isconfirmed ? patternResult : fourHourConfirmed[1]

var bool oneHourConfirmed = false
if timeframe.isintraday and timeframe.multiplier == 60
    oneHourConfirmed := barstate.isconfirmed ? patternResult : oneHourConfirmed[1]

// --- Request higher timeframe flags ---
dailyConfirmed_LTF = request.security(syminfo.tickerid, "D", dailyConfirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
t3confirmed_LTF = request.security(syminfo.tickerid, "D", t3confirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
fourHourConfirmed_LTF = request.security(syminfo.tickerid, "240", fourHourConfirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
oneHourConfirmed_LTF = request.security(syminfo.tickerid, "60", oneHourConfirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1

// --- Original Debugging Labels ---
if timeframe.period == "D" and patternResult
    label.new(bar_index, high, "T2", style=label.style_label_down, color=color.green, textcolor=color.white)

if timeframe.period == "D" and t3patternResult
    label.new(bar_index, low, "T3", style=label.style_label_upper_left, color=color.orange, textcolor=color.white)

if timeframe.period == "240" and (dailyConfirmed_LTF or t3confirmed_LTF) and patternResult
    label.new(bar_index, high, "4h", style=label.style_label_down, color=color.orange, textcolor=color.white)

if timeframe.period == "60" and (dailyConfirmed_LTF or t3confirmed_LTF) and patternResult
    label.new(bar_index, high, "1h", style=label.style_label_down, color=color.red, textcolor=color.white)

if timeframe.period == "15" and (((fourHourConfirmed_LTF and dailyConfirmed_LTF) or (fourHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
    label.new(bar_index, low, "15m", style=label.style_label_up, color=color.orange, textcolor=color.white)

if timeframe.period == "1" and (((oneHourConfirmed_LTF and dailyConfirmed_LTF) or (oneHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
    label.new(bar_index, low, "1m_1h", style=label.style_label_up, color=color.new(color.red, 0), textcolor=color.white)

if timeframe.period == "1" and (((fourHourConfirmed_LTF and dailyConfirmed_LTF) or (fourHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
    label.new(bar_index, low, "1m_4h", style=label.style_label_upper_right, color=color.new(color.purple, 0), textcolor=color.white)

if timeframe.period == "10S" and (((oneHourConfirmed_LTF and dailyConfirmed_LTF) or (oneHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
    label.new(bar_index, low, "10S", style=label.style_label_up, color=color.olive, textcolor=color.white)

// --- Entry Conditions for Strategy ---
entry15m = timeframe.period == "15" and (((fourHourConfirmed_LTF and dailyConfirmed_LTF) or (fourHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
entry1m_1h = timeframe.period == "1" and (((oneHourConfirmed_LTF and dailyConfirmed_LTF) or (oneHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
entry1m_4h = timeframe.period == "1" and (((fourHourConfirmed_LTF and dailyConfirmed_LTF) or (fourHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)
entry10s = timeframe.period == "10S" and (((oneHourConfirmed_LTF and dailyConfirmed_LTF) or (oneHourConfirmed_LTF and t3confirmed_LTF)) and patternResult)

// --- Fixed Stop Loss Below EMA200 ---
fixed_stop = ema200_main

// --- Submit Strategy Orders ---
if entry15m or entry1m_1h or entry1m_4h or entry10s
    strategy.entry("Long", strategy.long)
    strategy.exit("Stop Loss", from_entry="Long", stop=fixed_stop, when=low <= fixed_stop)

// --- Plot Stop Loss Line While in Trade ---
plot(strategy.position_size > 0 ? fixed_stop : na, title="Stop Loss", color=color.fuchsia, linewidth=2, style=plot.style_line)

