//@version=5
indicator("Tier 2 Pattern with Cascading Gates (CAPA)", overlay=true, shorttitle="T2DP_Cascaded")

// Plot EMAs on the chart
ema10_main  = ta.ema(close, 10)
ema20_main  = ta.ema(close, 20)
ema200_main = ta.ema(close, 200)
plot(ema10_main, title="EMA 10", color=color.blue)
plot(ema20_main, title="EMA 20", color=color.red)
plot(ema200_main, title="EMA 200", color=color.orange)

// Helper function to check conditions
crosses(_ema) =>
    (low < _ema) and (high > _ema)

// Tier 2 pattern detection function
f_tier2Pattern() =>
    ema10  = ta.ema(close, 10)
    ema20  = ta.ema(close, 20)
    ema200 = ta.ema(close, 200)
    emaTrendOk = (ema10 > ema20) and (ema20 > ema200)
    var bool restricted = false
    var bool bearishCandidate = false
    var bool justReset = false
    justReset := false

    if restricted
        if (close > open) and (close > ema10)
            restricted := false
            justReset := true
            bearishCandidate := false

    var bool permission = false
    if not restricted and not justReset and emaTrendOk
        condA = (close > open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        condBearCandidate = (close < open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        if condBearCandidate
            bearishCandidate := true
        condBConfirm = bearishCandidate and (close > open) and (close > ema10)
        if condA or condBConfirm
            permission := true
            bearishCandidate := false

    if not restricted and not justReset
        if (open < ema20) or (close < ema20)
            restricted := true
            bearishCandidate := false

    result = permission and barstate.isconfirmed and (not restricted)
    permission := false
    result

// ------------------- Cascading Permission Logic -------------------

// Declare persistent variables for each confirmation flag
var bool dailyConfirmed = false
var bool fourhConfirmed = false
var bool onehConfirmed = false
var bool min1Confirmed = false
var bool min15Confirmed = false
var bool sec10Confirmed = false

// Create a variable to store permission for the higher timeframes
var bool dailyPermissionPrev = false
var bool fourhPermissionPrev = false
var bool onehPermissionPrev = false

// Recalculate dailyConfirmed based on the previous day
dailyConfirmed := request.security(syminfo.tickerid, "D", f_tier2Pattern() ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
dailyPermissionPrev := dailyConfirmed[1] // Previous day's confirmation flag for lower timeframes

// Recalculate 4hConfirmed based on the previous day's permission
fourhConfirmed := request.security(syminfo.tickerid, "240", dailyPermissionPrev ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
fourhPermissionPrev := fourhConfirmed[1] // Previous 4h confirmation flag for lower timeframes

// Recalculate 1hConfirmed based on the previous 4h permission
onehConfirmed := request.security(syminfo.tickerid, "60", fourhPermissionPrev ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
onehPermissionPrev := onehConfirmed[1] // Previous 1h confirmation flag for lower timeframes

// Recalculate 15m and 1m based on the previous 1h permission
min15Confirmed := request.security(syminfo.tickerid, "15", onehPermissionPrev ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
min1Confirmed := request.security(syminfo.tickerid, "1", min15Confirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1
sec10Confirmed := request.security(syminfo.tickerid, "10S", min1Confirmed ? 1 : 0, lookahead=barmerge.lookahead_off) == 1

// ------------------- Debugging Labels -------------------

// Daily label appears only if previous day confirmed and permission exists
if timeframe.period == "D" and f_tier2Pattern() and dailyPermissionPrev
    label.new(bar_index, high, "T2", style=label.style_label_down, color=color.green, textcolor=color.white)

// 4h label appears only if previous day confirmed and permission exists
if timeframe.period == "240" and f_tier2Pattern() and fourhConfirmed and dailyPermissionPrev
    label.new(bar_index, high, "4h", style=label.style_label_down, color=color.orange, textcolor=color.white)

// 1h label appears only if previous 4h confirmed and permission exists
if timeframe.period == "60" and f_tier2Pattern() and onehConfirmed and fourhPermissionPrev
    label.new(bar_index, high, "1h", style=label.style_label_down, color=color.red, textcolor=color.white)

// 15m label appears only if previous 1h confirmed and permission exists
if timeframe.period == "15" and f_tier2Pattern() and min15Confirmed and onehPermissionPrev
    label.new(bar_index, low, "15m", style=label.style_label_up, color=color.orange, textcolor=color.white)

// 1m label appears only if previous 1h confirmed and permission exists
if timeframe.period == "1" and f_tier2Pattern() and min1Confirmed and onehPermissionPrev
    label.new(bar_index, low, "1m", style=label.style_label_up, color=color.red, textcolor=color.white)

// 10s label appears only if previous 1m confirmed and permission exists
if timeframe.period == "10S" and f_tier2Pattern() and sec10Confirmed and min1Confirmed
    label.new(bar_index, high, "10s", style=label.style_label_left, color=color.red, textcolor=color.white)
