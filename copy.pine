//@version=5
indicator("Tier 2 Pattern (CAPA)", overlay=true, shorttitle="T2DP")

// EMA lengths and calculations
emaLen10  = 10
emaLen20  = 20
emaLen200 = 200

ema10  = ta.ema(close, emaLen10)
ema20  = ta.ema(close, emaLen20)
ema200 = ta.ema(close, emaLen200)

// Plot EMAs with specified colors
plot(ema10,  title="EMA 10",  color=color.blue)
plot(ema20,  title="EMA 20",  color=color.red)
plot(ema200, title="EMA 200", color=color.orange)

// Check EMA hierarchy condition: EMA10 > EMA20 > EMA200
emaTrendOk = (ema10 > ema20) and (ema20 > ema200)

// A helper function to detect if the candle crosses a given EMA
crosses(emaVal) =>
    (low < emaVal) and (high > emaVal)

// Persistent variables to manage states across candles
var bool restricted        = false  // True if waiting for a reset candle after restriction
var bool bearishCandidate  = false  // Set when a bearish candidate pattern is detected (waiting for next candle)
var bool justReset         = false  // True on the bar that exits restriction, so we skip pattern detection on that bar

// Reset justReset to false at the start of each new bar
justReset := false

// Store label permissions for higher timeframes
var bool dailyPermission = false
var bool fourHourPermission = false
var bool oneHourPermission = false

// Store previous candles' labels
var bool prevDailyLabel = false
var bool prev4hLabel = false
var bool prev1hLabel = false

// Daily Timeframe Permission (when the daily candle closes and meets the pattern)
if (ta.change(time("D")))  // A new daily candle
    // Check daily pattern conditions
    if (emaTrendOk and (close > open) and crosses(ema10))  // Example condition for pattern
        dailyPermission := true
    else
        dailyPermission := false

    // Store the label permission for the previous daily candle
    prevDailyLabel := dailyPermission

// 4-Hour Timeframe Permission (Check if daily candle had permission)
fourHourPermission := prevDailyLabel and ta.change(time("240"))  // Reset every new 4-hour candle
// 1-Hour Timeframe Permission (Check if daily candle had permission)
oneHourPermission := prevDailyLabel and ta.change(time("60"))  // Reset every new 1-hour candle

// Lower timeframe permissions based on higher timeframes
var bool fifteenMinPermission = false
var bool oneMinPermission = false
fifteenMinPermission := prev4hLabel and ta.change(time("15"))
oneMinPermission := prev4hLabel and ta.change(time("1"))

// Smallest timeframes (for example 10s and 1m)
var bool tenSecPermission = false
var bool oneSecPermission = false
tenSecPermission := prev1hLabel and ta.change(time("10"))
oneSecPermission := prev1hLabel and ta.change(time("1"))

// --- Enforcing EMA Condition More Strictly ---

// Condition A: Single Bullish Candle (candle must close and high above EMA10)
condA = (close > open) and (crosses(ema10) or crosses(ema20)) and (close > ema10) and (high > ema10)  // Enforcing high > EMA10

// Condition B: Bearish then Bullish Pattern (bearish followed by bullish candle)
condBearCandidate = (close < open) and (crosses(ema10) or crosses(ema20)) and (close > ema10)
condBConfirm = bearishCandidate and (close > open) and (close > ema10)

// Check if permission is granted for current lower timeframe and meets conditions
if (fifteenMinPermission or oneMinPermission)
    if (condA or condBConfirm)
        label.new(x=bar_index, y=high, text="T2", style=label.style_label_down, color=color.green, textcolor=color.white)

if (tenSecPermission or oneSecPermission)
    if (condA or condBConfirm)
        label.new(x=bar_index, y=high, text="T2", style=label.style_label_down, color=color.green, textcolor=color.white)
