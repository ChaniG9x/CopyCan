//@version=5
indicator("Cascading MTF Pattern Detector", overlay=true)

// === EMA CALCULATIONS ===
ema10 = ta.ema(close, 10)
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
ema200 = ta.ema(close, 200)

// === PLOT EMAs ===
plot(ema10, title="EMA 10", color=color.blue, linewidth=2)
plot(ema20, title="EMA 20", color=color.red, linewidth=2)
plot(ema200, title="EMA 200", color=color.orange, linewidth=2)

// === EMA ALIGNMENT ===
emaBullAlign = ema10 > ema20 and ema20 > ema50 and ema50 > ema200

// === PATTERN CONDITIONS ===
condA(ema) => close > open and low < ema and high > ema and close > ema
condB(ema) => close[1] < open[1] and low[1] < ema and high[1] > ema and close > open and close > ema

// === RESET CONDITION ===
var bool restricted = false
if (open < ema20 or close < ema20)
    restricted := true
if condA(ema10)
    restricted := false

// === TIMEFRAME DETECTION ===
tf = timeframe.period
is10s = tf == "10S"
is1m = tf == "1"
is15m = tf == "15"
is1h = tf == "60"
is4h = tf == "240"
is1d = tf == "D"

// === CONFIRMATION FUNCTION ===
getConfirmation(tf) =>
    ema = request.security(syminfo.tickerid, tf, ta.ema(close, 10))
    a = request.security(syminfo.tickerid, tf, condA(ema))
    b = request.security(syminfo.tickerid, tf, condB(ema))
    a or b

// === PERMISSION CASCADE ===
permFromDaily = getConfirmation("D")
permFrom4H = getConfirmation("240")
permFrom1H = getConfirmation("60")

// === DETERMINE PERMISSION FOR CURRENT TIMEFRAME ===
permissionGranted = 
     is1d ? true :
     is4h or is1h ? permFromDaily :
     is15m or (is1m and not is1h and not is4h) ? permFrom4H :
     is10s ? permFrom1H : false

// === FINAL SIGNAL ===
patternA = condA(ema10)
patternB = condB(ema10)
patternDetected = (patternA or patternB) and not restricted and permissionGranted and emaBullAlign

// === LABEL ===
if patternDetected
    label.new(bar_index, high, "Pattern", style=label.style_label_up, color=color.green, textcolor=color.white)
