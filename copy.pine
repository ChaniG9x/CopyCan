//@version=5
indicator("T2 Cascading Confirmation Template", overlay=true)

// --- Core pattern detection function ---
f_detectT2(_open, _high, _low, _close) =>
    ema10 = ta.ema(_close, 10)
    ema20 = ta.ema(_close, 20)
    ema200 = ta.ema(_close, 200)

    cond_cross_ema10 = _low <= ema10 and _high >= ema10
    cond_green = _close > _open and _close > ema10
    cond_ema_order = ema10 > ema20 and ema20 > ema200

    cond_prev_above_20 = _open[1] > ema20[1] and _close[1] > ema20[1]
    cond_prev_green_above_10 = _close[1] > _open[1] and _close[1] > ema10[1]
    cond_prev_red_touch = _close[1] < _open[1] and _low[1] <= ema10[1] and _close[1] > ema10[1]

    cond_current_green = _close > _open

    condA = cond_prev_above_20 and cond_cross_ema10 and cond_green and cond_ema_order
    condB = cond_prev_green_above_10 and cond_cross_ema10 and cond_green and cond_ema_order
    condC = cond_prev_red_touch and cond_current_green and cond_ema_order

    condA or condB or condC

// --- Higher timeframe confirmations (explicit true/false, float logic) ---
var bool dailyConfirmed = false
if timeframe.isdaily
    if barstate.isconfirmed
        dailyConfirmed := f_detectT2(open, high, low, close)
    else
        dailyConfirmed := dailyConfirmed[1]

var bool fourHourConfirmed = false
if timeframe.isintraday and timeframe.multiplier == 240
    if barstate.isconfirmed
        fourHourConfirmed := f_detectT2(open, high, low, close)
    else
        fourHourConfirmed := fourHourConfirmed[1]

var bool oneHourConfirmed = false
if timeframe.isintraday and timeframe.multiplier == 60
    if barstate.isconfirmed
        oneHourConfirmed := f_detectT2(open, high, low, close)
    else
        oneHourConfirmed := oneHourConfirmed[1]

// --- Lower timeframe lookups ---
dailyConfirmed_LTF     = request.security(syminfo.tickerid, "D", dailyConfirmed[1], lookahead=barmerge.lookahead_on)
fourHourConfirmed_LTF  = request.security(syminfo.tickerid, "240", fourHourConfirmed[1], lookahead=barmerge.lookahead_on)
oneHourConfirmed_LTF   = request.security(syminfo.tickerid, "60", oneHourConfirmed[1], lookahead=barmerge.lookahead_on)

// --- LTF logic examples ---
// 4H and 1H unlocked only if Daily was confirmed
timeframeIs4H = timeframe.multiplier == 240
if timeframeIs4H and dailyConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, high, "T2 (4H)", style=label.style_label_down, color=color.green)

timeframeIs1H = timeframe.multiplier == 60
if timeframeIs1H and dailyConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, high, "T2 (1H)", style=label.style_label_down, color=color.orange)

// 15m and 1m unlocked by 4H
timeframeIs15m = timeframe.multiplier == 15
if timeframeIs15m and fourHourConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, high, "T2 (15m)", style=label.style_label_down, color=color.blue)

timeframeIs1m = timeframe.multiplier == 1
if timeframeIs1m and fourHourConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, high, "T2 (1m via 4H)", style=label.style_label_down, color=color.blue)

// 10s and 1m unlocked by 1H
is10s = timeframe.in_seconds() and timeframe.multiplier == 10
if is10s and oneHourConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, high, "T2 (10s)", style=label.style_label_down, color=color.fuchsia)

if timeframeIs1m and oneHourConfirmed_LTF and f_detectT2(open, high, low, close) and barstate.isconfirmed
    label.new(bar_index, low, "T2 (1m via 1H)", style=label.style_label_up, color=color.yellow)
