//@version=5
indicator("Tier 2 Pattern with Cascading Gates (CAPA)", overlay=true, shorttitle="T2DP_Cascaded")

// Plot EMAs on the chart
ema10_main  = ta.ema(close, 10)
ema20_main  = ta.ema(close, 20)
ema200_main = ta.ema(close, 200)
plot(ema10_main, title="EMA 10", color=color.blue)
plot(ema20_main, title="EMA 20", color=color.red)
plot(ema200_main, title="EMA 200", color=color.orange)

// Helper function defined at the top level
crosses(_ema) =>
    (low < _ema) and (high > _ema)

// The stateful Tier 2 pattern detection function
f_tier2Pattern() =>
    // EMA settings and calculations
    emaLen10  = 10
    emaLen20  = 20
    emaLen200 = 200
    ema10  = ta.ema(close, emaLen10)
    ema20  = ta.ema(close, emaLen20)
    ema200 = ta.ema(close, emaLen200)
    // Check EMA hierarchy: EMA10 > EMA20 > EMA200
    emaTrendOk = (ema10 > ema20) and (ema20 > ema200)
    
    // Persistent state variables so that each timeframe instance maintains its own state
    var bool restricted       = false   // Set when the candle triggers a restriction
    var bool bearishCandidate = false   // Set when a bearish candidate is detected (waiting for confirmation)
    var bool justReset        = false   // True on the bar that resets restriction
    // Reset justReset at the start of each bar
    justReset := false

    // If currently restricted, check if this candle resets the restriction.
    if restricted
        // Reset if a bullish candle closes above EMA10.
        if (close > open) and (close > ema10)
            restricted       := false
            justReset        := true
            bearishCandidate := false

    // The detection logic is run only if not restricted, not on the reset bar, and if the EMA trend is valid.
    var bool permission = false
    if not restricted and not justReset and emaTrendOk
        // Condition A: A single bullish candle which crosses EMA10 or EMA20 and closes above EMA10.
        condA = (close > open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        
        // Condition B is a two-candle sequence. First, mark a bearish candidate candle:
        condBearCandidate = (close < open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)
        if condBearCandidate
            bearishCandidate := true
        // Then, if the current candle confirms the candidate (bullish and closes above EMA10):
        condBConfirm = bearishCandidate and (close > open) and (close > ema10)
        
        // If either condition is met, permission is granted.
        if condA or condBConfirm
            permission       := true
            bearishCandidate := false

    // After detection, if not in a reset state, check if the current candle should trigger a restriction.
    if not restricted and not justReset
        if (open < ema20) or (close < ema20)
            restricted       := true
            bearishCandidate := false

    // Store the permission result, then reset permission for the next bar.
    result = permission
    permission := false
    result

// ---------------------- Cascading Gates ----------------------
// Daily gate: Look at the previous daily candle.
// If the pattern was present on the previous daily candle, the gate becomes active.
dailyGate = request.security(syminfo.tickerid, "D", f_tier2Pattern()[1], lookahead=barmerge.lookahead_off)

// Use the daily gate to allow pattern search on 4h and 1h for the current day.
pattern_4h = dailyGate and request.security(syminfo.tickerid, "240", f_tier2Pattern(), lookahead=barmerge.lookahead_off)
pattern_1h = dailyGate and request.security(syminfo.tickerid, "60",  f_tier2Pattern(), lookahead=barmerge.lookahead_off)

// 4h gate: Look at the previous 4h candle.
// If active, allow searching on 15min and 1min timeframes.
gate_4h = request.security(syminfo.tickerid, "240", f_tier2Pattern()[1], lookahead=barmerge.lookahead_off)
pattern_15m      = gate_4h and request.security(syminfo.tickerid, "15", f_tier2Pattern(), lookahead=barmerge.lookahead_off)
pattern_1m_from4h = gate_4h and request.security(syminfo.tickerid, "1",  f_tier2Pattern(), lookahead=barmerge.lookahead_off)

// 1h gate: Look at the previous 1h candle.
// If active, allow searching on the 1min and 10-sec timeframes.
gate_1h = request.security(syminfo.tickerid, "60", f_tier2Pattern()[1], lookahead=barmerge.lookahead_off)
pattern_1m_from1h = gate_1h and request.security(syminfo.tickerid, "1",  f_tier2Pattern(), lookahead=barmerge.lookahead_off)
pattern_10s       = gate_1h and request.security(syminfo.tickerid, "10S", f_tier2Pattern(), lookahead=barmerge.lookahead_off)

// ---------------------- Debugging Labels ----------------------
// The following labels are drawn only if the chart's current resolution matches the intended timeframe.

// Daily gate label appears only on a Daily chart.
if timeframe.period == "D" and dailyGate
    label.new(bar_index, high, "Daily Gate", style=label.style_label_down, color=color.blue, textcolor=color.white)

// 4h pattern label appears only on a 4h chart.
if timeframe.period == "240" and pattern_4h
    label.new(bar_index, high, "4h Pattern", style=label.style_label_down, color=color.green, textcolor=color.white)

// 1h pattern label appears only on a 1h chart.
if timeframe.period == "60" and pattern_1h
    label.new(bar_index, high, "1h Pattern", style=label.style_label_down, color=color.green, textcolor=color.white)

// 4h gate label appears only on a 4h chart.
if timeframe.period == "240" and gate_4h
    label.new(bar_index, low, "4h Gate", style=label.style_label_up, color=color.purple, textcolor=color.white)

// 15m pattern label appears only on a 15min chart.
if timeframe.period == "15" and pattern_15m
    label.new(bar_index, low, "15m Pattern", style=label.style_label_up, color=color.orange, textcolor=color.white)

// 1m (from 4h) label appears only on a 1min chart.
if timeframe.period == "1" and pattern_1m_from4h
    label.new(bar_index, low, "1m (from 4h)", style=label.style_label_up, color=color.orange, textcolor=color.white)

// 1h gate label appears only on a 1h chart.
if timeframe.period == "60" and gate_1h
    label.new(bar_index, high, "1h Gate", style=label.style_label_left, color=color.red, textcolor=color.white)

// 1m (from 1h) label appears only on a 1min chart.
if timeframe.period == "1" and pattern_1m_from1h
    label.new(bar_index, high, "1m (from 1h)", style=label.style_label_left, color=color.red, textcolor=color.white)

// 10s pattern label appears only on a 10-sec chart.
if timeframe.period == "10S" and pattern_10s
    label.new(bar_index, high, "10s Pattern", style=label.style_label_left, color=color.red, textcolor=color.white)
