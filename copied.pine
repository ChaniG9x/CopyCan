//@version=5
indicator("Multi-Timeframe T2 Labels Fixed", overlay=true)

// === 1. Calculate EMAs on current timeframe ===
ema10  = ta.ema(close, 10)
ema20  = ta.ema(close, 20)
ema200 = ta.ema(close, 200)

// Plot EMAs
plot(ema10, title="EMA 10", color=color.blue)
plot(ema20, title="EMA 20", color=color.red)
plot(ema200, title="EMA 200", color=color.orange)

// === 2. Define T2 condition function for a given timeframe ===
t2ConditionFunc() =>
    _ema10  = ta.ema(close, 10)
    _ema20  = ta.ema(close, 20)
    _ema200 = ta.ema(close, 200)
    _trendOk = (_ema10 > _ema20) and (_ema20 > _ema200)
    _bullish = (close > open)
    _trendOk and _bullish

// === 3. Request previous candle's T2 condition for higher timeframes ===
// Use [1] to get the condition from the previous candle

// Daily: For 1H and 4H dependency
previousDayT2 = request.security(syminfo.tickerid, "D", t2ConditionFunc(), lookahead=barmerge.lookahead_off)[1]

// 4-hour: For 15m and 1m dependency
previous4HT2 = request.security(syminfo.tickerid, "240", t2ConditionFunc(), lookahead=barmerge.lookahead_off)[1]

// 1-hour: For 10sec and 1m dependency
previous1HT2 = request.security(syminfo.tickerid, "60", t2ConditionFunc(), lookahead=barmerge.lookahead_off)[1]

// === 4. Define current timeframe T2 condition (using current chart's EMAs) ===
emaTrendOk = (ema10 > ema20) and (ema20 > ema200)
currentT2 = emaTrendOk and (close > open)

// === 5. Plot labels only when all conditions are met and only on confirmed bars ===

// For 1H and 4H charts (dependent on previous daily T2)
if timeframe.isminutes and timeframe.multiplier == 60 and barstate.isconfirmed and previousDayT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)

if timeframe.isminutes and timeframe.multiplier == 240 and barstate.isconfirmed and previousDayT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)

// For 15m and 1m charts (dependent on previous 4H T2)
if timeframe.isminutes and timeframe.multiplier == 15 and barstate.isconfirmed and previous4HT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)

if timeframe.isminutes and timeframe.multiplier == 1 and barstate.isconfirmed and previous4HT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)

// For 1m and 10sec charts (dependent on previous 1H T2)
if timeframe.isminutes and timeframe.multiplier == 1 and barstate.isconfirmed and previous1HT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)

if timeframe.isminutes and timeframe.multiplier == 10 and barstate.isconfirmed and previous1HT2 and currentT2
    label.new(bar_index, high, text="T2", color=color.green, textcolor=color.white, style=label.style_label_down)
