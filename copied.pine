//@version=5
indicator("Tier 2 Daily Pattern", overlay=true, shorttitle="T2DP")

// Ensure this script runs on the daily timeframe only for label plotting
isDaily = timeframe.isdaily

// EMA lengths and calculations
emaLen10 = 10
emaLen20 = 20
emaLen200 = 200

ema10 = ta.ema(close, emaLen10)
ema20 = ta.ema(close, emaLen20)
ema200 = ta.ema(close, emaLen200)

// Plot EMAs with specified colors
plot(ema10, title="EMA 10", color=color.blue)
plot(ema20, title="EMA 20", color=color.red)
plot(ema200, title="EMA 200", color=color.orange)

// Check EMA hierarchy condition: EMA10 > EMA20 > EMA200
emaTrendOk = (ema10 > ema20) and (ema20 > ema200)

// Function to detect if the candle crosses a given EMA
crosses(emaVal) =>
    // If the candle's low is below and its high is above the EMA, we assume a cross occurred
    (low < emaVal) and (high > emaVal)

// Persistent variables to manage state across candles
var bool restricted = false      // True if waiting for a reset candle after restriction condition
var bool bearishCandidate = false  // Set when a bearish candidate pattern is detected (requires confirmation on next candle)

// Reset the bearish candidate if the candle does not follow through
if not (barstate.islast)
    bearishCandidate := false

// Reset logic for the restricted state: if currently restricted, wait for a bullish candle closing above EMA10
if restricted
    if (close > open) and (close > ema10)
        // This candle resets the restriction, but is not counted as a valid Tier 2 pattern
        restricted := false
        bearishCandidate := false

// Check for restriction condition on the current candle:
// If a candle's open OR close is below the EMA20, then we set the restriction.
// This check happens only if we're not already in a restricted state.
if not restricted and ( (open < ema20) or (close < ema20) )
    restricted := true

// Variable to flag permission (i.e. valid Tier 2 Daily Pattern)
var bool permission = false

// Process patterns only if we are not in a restricted state and the EMA trend is valid
if not restricted and emaTrendOk

    // Condition A: Single bullish candle pattern
    // - Candle must be bullish (close > open)
    // - Candle must cross either EMA10 or EMA20
    // - Candle must close above EMA10
    condA = (close > open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)

    // Condition B: Bearish then bullish sequence
    // First, detect a bearish candidate candle:
    // - Candle is bearish (close < open)
    // - Candle crosses EMA10 or EMA20
    // - Candle closes above EMA10
    condBearCandidate = (close < open) and ((crosses(ema10)) or (crosses(ema20))) and (close > ema10)

    // If a bearish candidate is found, mark it for the next day
    if condBearCandidate
        bearishCandidate := true

    // Now, if a bearish candidate exists from the previous day, check the current candle for confirmation:
    // - Current candle must be bullish and close above EMA10
    condBConfirm = bearishCandidate and (close > open) and (close > ema10)

    // Set permission if either Condition A or Condition B is met
    if condA or condBConfirm
        permission := true
        bearishCandidate := false  // Reset candidate after confirmation

// On the daily timeframe, plot the debugging label "T2" in green if permission is granted at candle close
if isDaily and permission and barstate.isconfirmed
    label.new(x=bar_index, y=high, text="T2", style=label.style_label_down, color=color.new(color.green,0), textcolor=color.white)

// Reset permission flag for next candle
permission := false
